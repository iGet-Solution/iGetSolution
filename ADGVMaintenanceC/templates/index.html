<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Système de Ticket by ADGVGROUPE V2.0</title>
    <link rel="icon" type="image/png" href="{{ url_for('static', filename='redim.png') }}">
    <link rel="stylesheet"href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
/>

    
    <!-- Lien vers le fichier CSS externe -->
    <link rel="stylesheet" href="{{ url_for('static', filename='StylePrincipal.css') }}">

    <!-- FullCalendar CSS -->
    <link href="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.css" rel="stylesheet" />
</head>
<body>
    <!-- Conteneur principal -->
    <div class="form-container">
        <!-- Logo -->
        <div class="logo-container">
            <img src="{{ url_for('static', filename='img/logoadgvlogin.png') }}" alt="Logo de la boîte" class="logo">
        </div>

        <!-- Titre principal -->
        <h1 class="form-title">Bienvenue, {{ username }}</h1>
        <h2 class="form-subtitle">Demande de ticket d'intervention de maintenance</h2>

        <!-- Emplacement pour le message flash -->
        {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            <div id="flash-message" style="margin-bottom: 10px;">
                {% for category, message in messages %}
                    <div class="alert alert-{{ category }}" role="alert">
                        {{ message }}
                    </div>
                {% endfor %}
            </div>
        {% endif %}
    {% endwith %}
    

        <!-- Formulaire pour ajouter un ticket -->
        <form action="{{ url_for('index') }}" method="POST" class="ticket-form">
            <label for="last_name">Nom :</label>
            <input type="text" name="last_name" id="last_name" value="{{ username }}" readonly>

            <label for="email">Email :</label>
            <input type="email" name="email" id="email" value="{{ email }}" readonly>

            <label for="title">Titre de la demande :</label>
            <input type="text" name="title" id="title" placeholder="Votre demande d'intervention" value="{{ title or '' }}" required>

            <label for="description">Description :</label>
            <textarea name="description" id="description" rows="3" placeholder="Décrivez votre demande..." required>{{ description or '' }}</textarea>
             <!-- Ajout de la case pour urgence -->
             <div class="urgent-wrapper">
                <span class="urgent-label">Est-ce une demande urgente ?</span>
                <label class="urgent-toggle">
                    <input type="checkbox" name="urgent" id="urgent">
                    <span class="urgent-slider"></span>
                </label>
                <small class="text-muted">Cochez cette case uniquement si votre demande nécessite une intervention urgente,cela permet au système de vous proposer un créneau plus tôt, même si certains jours sont partiellement bloqués.</small>
            </div>
            
            <button type="button" id="next-available-btn" class="btn btn-secondary">
                Cliquez ici pour choisir automatiquement la première date disponible selon le planning
            </button>
            
            
            <label for="slot_time">Choisir un créneau manuellement:</label>
            <input type="datetime-local" name="slot_time" id="slot_time" required>

             
            <button type="submit" class="submit-button">Ajouter un ticket</button>
        </form>
    </div>

    <!-- Calendrier des créneaux -->
    <section class="calendar-container">
        <h3 class="section-title">Calendrier des Créneaux</h3>
        <div id="calendar" class="calendar-section"></div>
    </section>

<!-- Liste des tickets -->
<section class="ticket-list-container">
    <h3 class="section-title">Liste des Tickets</h3>
    <table class="ticket-table">
        <thead>
            <!-- Ligne des en-têtes -->
            <tr>
                <th>ID</th>
                <th>
                    <div class="filter-container">
                        <span>Nom</span>
                        <select id="filter-name" class="filter-dropdown" onchange="filterByName()" aria-label="Filtrer par nom">
                            <option value="">-- Nom Global --</option>
                            {% for ticket in raw_tickets | unique(attribute='name') %}
                            <option value="{{ ticket.name }}">{{ ticket.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </th>
                <th>Email</th>
                <th>Titre</th>
                <th>Description</th>
                <th id="sortDateBtn" style="cursor: pointer;">
                    Date et Heure
                    <i class="fas fa-arrow-up"></i> <!-- Icône pour le tri -->
                </th>                
                <th>
                    <div class="filter-container">
                        <span>Statut</span>
                        <select id="filter-status" class="filter-dropdown" onchange="filterByStatus()" aria-label="Filtrer par statut">
                            <option value="">-- Tous les Statuts --</option>
                            {% for ticket in raw_tickets | unique(attribute='status') %}
                            <option value="{{ ticket.status }}">{{ ticket.status }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </th>
                <th>Commentaire de Sylvain</th>
            </tr>
        </thead>
        <tbody>
            {% for ticket in raw_tickets %}
            <tr class="ticket-row" data-date="{{ ticket.slot_time }}">
                <td>{{ ticket.id }}</td>
                <td class="name-cell">{{ ticket.name }}</td>
                <td>{{ ticket.email }}</td>
                <td>{{ ticket.title }}</td>
                <td>{{ ticket.description }}</td>
                <td>
                    Début : {{ ticket.slot_time|format_datetime('%d/%m/%Y %H:%M') }}<br>
                    Fin : {{ ticket.end_time|format_datetime('%d/%m/%Y %H:%M') }}
                </td>
                <td>{{ ticket.status }}</td>
                <td>{{ ticket.admin_comment or "Aucun" }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</section>



   <!-- jQuery (obligatoire pour DataTables) -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<!-- DataTables CSS -->
<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">

<!-- DataTables JS -->
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>


    <!-- FullCalendar JS -->
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/locales/fr.js"></script>

    <!-- Injection des tickets dans le JavaScript -->
    <script>
        window.tickets = {{ tickets | tojson | safe }};
    </script>

    <!-- Lien vers ton fichier JS -->
    <script src="{{ url_for('static', filename='script.js') }}"></script>

    <!--bouton back-->

    <button id="back-to-top" class="back-to-top-btn">
        <i class="fa-solid fa-arrow-up"></i>
    </button>
    
    <!--bouton Déco-->
    
    <button id="logout-btn" class="logout-btn">
        <i class="fa-solid fa-power-off"></i>
    </button>
    
    



</body>
</html>

